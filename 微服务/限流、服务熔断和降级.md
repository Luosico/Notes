# 限流、服务熔断和降级

在互联网应用中，有很多突发性的高并发访问场景，比如秒杀等。此时访问量会远远超过系统所能处理的并发数，若所有流量全都进入服务器，很可能造成服务器宕机导致整个系统不可用。为保证系统在这些场景中仍然能够稳定的运行，就需要采用一定的系统保护策略，常见的策略有服务降级、限流和熔断。



## 限流

限流的主要目的是通过限制并发访问数或者限制一个时间窗口内允许处理的请求数量来保护系统，一旦达到条件就对当前请求采取对应的拒接策略

**限流触发条件**

![image-20210529152043032](https://raw.githubusercontent.com/Luosico/Typora/main/img/20210529152100.png)

**拒绝策略**

![image-20210529152130446](https://raw.githubusercontent.com/Luosico/Typora/main/img/20210529152130.png)

**目前常见的限流场景：**

- Nginx添加限流模块限制平均访问速度
- 设置数据库连接池、线程池的大小来限制总的并发数
- 通过Guava提供的Ratelimiter限制接口的访问速度
- TCP通信协议中的流量整形

### 限流算法

#### 1.计数器算法

​	这是一种比较简单的限流实现算法，在指定周期内累加访问次数，当访问次数达到设定的阈值时触发限流策略，当进入下一个时间周期内时访问次数清零

​	**弊端**：存在**临界问题**，若周期末和周期初分别接受了全部清楚，整体看就会在短时间内请求量为两倍阈值，超过了设置的阈值

#### 2.滑动窗口算法

​	解决了计数器算法的临界问题。TCP网络通信协议中就采用了滑动窗口来解决网络拥塞。

​	滑动窗口原理是在固定窗口中分割出多个小时间窗口，分别在每个小时间窗口中记录访问次数，然后根据时间将窗口往前滑动并删除过期的小时间窗口。最终只需要统计窗口范围内的所有小时间窗口。

#### 3.令牌桶限流算法

令牌桶是网络流量整形和速率限制中最常用的一种算法。

对于每个请求，都需要从令牌桶中获得一个令牌，如果没有获得令牌，则需要触发限流策略。

#### 4.漏桶限流算法

漏桶限流算法的主要作用是控制数据注入网络的速度，平滑网络上的突发流量。

漏桶算法内部维持一个容器，这个容器以恒定的速度出水，不管上面的水流速度多快，漏桶水滴的留出速度始终保持不变。

**漏桶限流算法和令牌桶限流算法的最大区别是漏桶无法处理短时间内的突发流量，是一种恒定速度的限流算法**



## 服务熔断

​	微服务中，由于服务拆分粒度较细，会出现请求链路较长的情况，对于一个请求，需要调用多个微服务才能完成。在高并发的场景中，这些依赖服务的稳定性对系统的影响非常大，当某个服务因为网络延迟或者请求超时等原因不可用时，就会导致当前请求阻塞，**一旦某个链路上被依赖的服务不可用，很可能出现请求堆积从而导致出现雪崩效应**。

​	**服务熔断是指当某个服务无法正常为服务调用者提供服务时，为了防止整个系统出现雪崩效应，暂时将出现故障的接口隔离出来，断绝与外部接口的联系**

​	触发熔断后，后续一段时间内该服务调用者的请求都会直接失败，知道目标服务恢复正常。

## 服务降级

​	**服务降级**是在服务器压力陡增的情况下，利用有限资源，根据当前业务情况，关闭某些服务接口或者页面，以此释放服务器资源以保证核心任务的正常运行

​	**流量控制**本质上是减小访问量，而服务处理能力不变；而服务降级本质上是降低了部分服务的处理能力，增强另一部分服务处理能力，而访问量不变。

#### 服务降级常见方案：

- 平均响应时间
- 异常比例
- 异常数量